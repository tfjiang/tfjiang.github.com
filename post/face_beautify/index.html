<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>美颜相机之磨皮&#43;美白 &middot; 闲人草堂</title>
  <link rel="stylesheet" href="http://tfjiang.github.io//css/style.css" />
  <link rel="stylesheet" href="http://tfjiang.github.io//css/font-awesome.min.css" />
  <link href='https://fonts.googleapis.com/css?family=Lato:100,300,400,600' rel='stylesheet' type='text/css'>
</head>
<body>

<header class="header" style="background-color: #009DDC;
    background-image: url(http://tfjiang.github.io//img/texture.png),linear-gradient(to bottom, #009DDC, #006ccb);background-repeat: repeat, no-repeat;background-position: left top, left top;background-size: 100px 100px, 100% 100%;" role="banner">

      <section id="branding">
        <div id="site-title"><a href="http://tfjiang.github.io/">闲人草堂</a></div>
        <nav id="mainmenu">
          <ul>
            <li><a href="http://tfjiang.github.io/">Articles</a></li>
            
            
            
          </ul>
        </nav>
        <input type="checkbox" id="op"></input>
        <div class="lower">
          <label for="op">Menu</label>
        </div>
        <div class="overlay overlay-hugeinc">
          <label for="op"></label>
          <nav id="menu" role="navigation">
            <ul>
            <li><a href="http://tfjiang.github.io/">Articles</a></li>
            
            
            
          </ul>
          </nav>
        </div>
        <div class="clearfix"></div>
      </section>
      <div class="post-heading">
        <h1>
        美颜相机之磨皮&#43;美白
          <div class="share-icons-header">
            <a href="http://www.twitter.com/share?url=http%3a%2f%2ftfjiang.github.io%2fpost%2fface_beautify%2f" target="_blank">
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
            <g>
              <g>
                <path d="M437.219,245.162c0-3.088-0.056-6.148-0.195-9.18c13.214-9.848,24.675-22.171,33.744-36.275
                  c-12.129,5.453-25.148,9.097-38.835,10.626c13.965-8.596,24.675-22.338,29.738-38.834c-13.075,7.928-27.54,13.603-42.924,16.552
                  c-12.323-14.021-29.904-22.95-49.35-23.284c-37.332-0.612-67.598,30.934-67.598,70.463c0,5.619,0.584,11.072,1.752,16.329
                  c-56.22-3.616-106.042-32.881-139.369-77c-5.814,10.571-9.152,22.922-9.152,36.164c0,25.037,11.934,47.291,30.071,60.421
                  c-11.099-0.5-21.503-3.866-30.627-9.375c0,0.306,0,0.612,0,0.918c0,34.996,23.312,64.316,54.245,71.159
                  c-5.675,1.613-11.656,2.448-17.804,2.421c-4.367-0.028-8.596-0.501-12.713-1.392c8.596,28.681,33.577,49.628,63.147,50.323
                  c-23.145,19.194-52.298,30.655-83.955,30.572c-5.453,0-10.849-0.361-16.135-1.029c29.933,20.53,65.456,32.491,103.65,32.491
                  C369.23,447.261,437.219,339.048,437.219,245.162z"/>
                <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
                  C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
                  S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
              </g>
            </svg></a>
            <a href="http://plus.google.com/share?url=http%3a%2f%2ftfjiang.github.io%2fpost%2fface_beautify%2f" target="_blank">
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
              <g>
                <g>
                  <path d="M349.146,402.251c0-30.016-17.387-44.815-36.525-60.922l-15.662-12.185c-4.785-3.895-11.294-9.124-11.294-18.693
                    c0-9.57,6.537-15.662,12.184-21.309c18.249-14.354,36.526-29.571,36.526-61.756c0-33.076-20.892-50.462-30.878-58.724l0,0h26.956
                    L358.271,153h-89.603c-23.479,0-53.049,3.478-77.863,23.924c-18.693,16.079-27.818,38.278-27.818,58.279
                    c0,33.911,26.093,68.294,72.188,68.294c4.368,0,9.125-0.445,13.937-0.863c-2.17,5.23-4.34,9.569-4.34,16.97
                    c0,13.464,6.955,21.753,13.047,29.57c-19.556,1.308-56.109,3.478-83.065,20.001c-25.676,15.217-33.493,37.416-33.493,53.077
                    c0,32.186,30.461,62.201,93.525,62.201C309.561,484.454,349.146,443.116,349.146,402.251z M255.621,291.34
                    c-37.415,0-54.384-48.292-54.384-77.418c0-11.322,2.17-23.034,9.569-32.186c6.955-8.707,19.139-14.382,30.461-14.382
                    c36.108,0,54.802,48.738,54.802,80.033c0,7.845-0.862,21.754-10.877,31.768C278.237,286.11,266.498,291.312,255.621,291.34z
                     M256.066,466.177c-46.54,0-76.556-22.171-76.556-53.049s27.846-41.311,37.416-44.787c18.276-6.093,41.755-6.982,45.677-6.982
                    c4.34,0,6.51,0,9.987,0.445c33.076,23.479,47.402,35.218,47.402,57.416C319.992,446.176,297.821,466.177,256.066,466.177z"/>
                  <polygon points="353.068,317.768 400.164,317.768 400.164,364.836 423.699,364.836 423.699,317.768 470.768,317.768 
                    470.768,294.233 423.699,294.233 423.699,247.165 400.164,247.165 400.164,294.233 353.068,294.233     "/>
                  <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
                    C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
                    S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
                </g>
            </svg></a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftfjiang.github.io%2fpost%2fface_beautify%2f" target="_blank">
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
            <g>
              <g>
                <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
                  C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
                  S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
                <path d="M317.739,482.617V306h58.279l9.208-58.529h-67.487v-29.348c0-15.272,5.007-29.849,26.928-29.849h43.813v-58.418h-62.201
                  c-52.298,0-66.569,34.438-66.569,82.175v35.413h-35.885V306h35.885v176.617H317.739L317.739,482.617z"/>
              </g>
            </svg>
            </a>
          </div>
          
        </h1>
      </div>

    </header>

    <div id="container">


<section id="content" role="main">
<section class="entry-meta">
  <span class="post-date">May 22, 2016</span>
</section></header>
<section class="entry-content">
<article>


<h2 id="磨皮功能:3e1a9d95fdd462bbec3ff1b72e4eb437">磨皮功能</h2>

<p>方法参考<a href="http://www.cnblogs.com/Imageshop/p/4709710.html">美颜</a>。算法步骤记录如下：</p>

<ul>
<li>输入图像src，并且复制src给highPass；</li>
<li>对highPass图像进行保边滤波，这样的滤波器有双边滤波器、表面模糊、导向滤波等，这里选用双边滤波器；</li>
<li>计算高反差图像 highPass = highPass – src+128；</li>
<li>对highPass进行高斯滤波；</li>
<li>将highPass与src进行线性光融合，得到process图：
process = (src *(100 – transparency)+(src + 2 * highPass -256) * transparency)/100。</li>
</ul>

<p>本算法中关键的恢复皮肤质感的步骤是第四步的高斯滤波，这个模糊的半径一般越大，质感越强，但是太大，磨皮效果就没有了，因此，这里需要把握合适的度。</p>

<p>第三步应用图像中常数128，也不一定是个定值，调大后，则处理后的图像整体偏亮，调小则图像偏暗。</p>

<p>第五步的图层的不透明度参数也是同样，调得越大，图片整体的斑点可能会偏多，偏小，图像会过于模糊，默认取<code>$50\%$</code>。</p>

<p>算法效率主要取决于第二步，也就是EPF滤波器，<strong>需要想办法提速</strong>。</p>

<h2 id="美白功能:3e1a9d95fdd462bbec3ff1b72e4eb437">美白功能</h2>

<ol>
<li><p>提供对比度：改善HSV颜色空间中亮度分量V。
<div>
    $$v(x,y) = \frac{\log(v(x,y)*(\beta-1)+1)}{\log(\beta)}$$
</div>
注意h,s,v分量都是浮点型。此处<code>$\beta$</code>是全局一致的，如果想要获得较好效果，就必须使用<code>$\beta(x,y)$</code> 函数，每个像素点处用的<code>$\beta$</code>不一样。具体见下。</p></li>

<li><p><code>$\beta$</code>函数构建方式：</p>

<ul>
<li>图像边界检测，使用sobel filter检测图像边界，构建一张bit表，根据一个给定的<code>$\sigma$</code>值，判断每个像素是edge，或者不是。</li>
<li>对于不是edge的像素，设置mask区域，计算平均亮度值。mask区域内并非每个像素都参与计算，根据预设的threshold，只有当<code>$|v_p-v_c|&lt;threshold$</code>，p点的亮度才会参与计算平均值。则：
<div>
$$\beta=\left \{ \begin{array}{ccc}
10\frac{v(x,y)-mean}{v(x,y)}+2, &amp; w(x,y) \geq mean, Sobel(x,y)  \leq \sigma\\
2, &amp; w(x,y) &lt; mean, Sobel(x,y) \leq \sigma\\
undefined, &amp; Sobel(x,y) &gt; \sigma
\end{array} \right.$$
</div></li>
<li>对于是edge的像素，设置mask区域，在区域内选择V值最近的那个像素点的<code>$\beta$</code>值</li>
</ul>

<p><strong>注：以上第二步无效果，本应用真正需要的是仅对肤色区域提高亮度。</strong></p></li>
</ol>

<h2 id="皮肤识别:3e1a9d95fdd462bbec3ff1b72e4eb437">皮肤识别</h2>

<p>皮肤识别的方案有多种，主要是根据不同颜色空间的模型进行区分。</p>

<ol>
<li><p>使用rgb颜色空间的二次多项式混合模型，通过<code>$r,g,b$</code>来识别皮肤，识别规则为：
<div>
$$\begin{array}{cccc}
R_1: &amp; g &gt; l_{lower}(r), g &lt; l_{upper}(r)\\
R_2: &amp; W(r,g) \leq 4e^{-4}\\
R_3: &amp; R&gt;G&gt;B\\
R_4: &amp; R-G \geq 45
\end{array}$$
</div>
上述 <code>$r,g,b$</code>为归一化后的数据：
<div>
$$\begin{array}{ccc}
r = &amp; \frac{R}{R+G+B} \\
g = &amp; \frac{G}{R+G+B} \\
b = &amp; \frac{B}{R+G+B}
\end{array}$$
</div>
且：
<div>
$$\begin{array}{ccc}
l_{upper}(r) = &amp; -1.3767r^2+1.0743r+0.1452\\
l_{lower}(r) = &amp; -0.776r^2+0.5601r+0.1766 \\
W(r,g)  = &amp; (r-0.33)^2+(g-0.33)^2
\end{array}$$
</div>
上述判断准则可以全部转换（近似）成整数运算：
<div>
$$\begin{array}{cccc}
R_{1,1}: &amp; 1000G*Sum &gt; -7760R^2+5601R*Sum+1766Sum^2\\
R_{1,2}: &amp; 10000G*Sum &lt; -13767R^2+10743R*Sum+1452Sum^2\\
R_2: &amp; (100R-33Sum)^2+(100G-33Sum)^2\geq 4Sum^2\\
R_3: &amp; R&gt;G&gt;B\\
R_4: &amp; R-G \geq 45
\end{array}$$
</div>
<strong>注：这个检测方法效果不理想，依赖输入图的白平衡等状态</strong></p>

<ol>
<li>使用<code>$YC_rC_b$</code>颜色空间，其中<code>Y</code>表示明亮度,<code>$C\_r,C\_b$</code>表示颜色的色调和饱和度。黄种人肤色的大致分布区间如下：
<div>
$$C_r\in [137,173],\quad
C_b\in [77,127]$$
</div>
<strong>注意：用这个方法可以比较容易得检测黄种人，但是对其他有色人种未必合适</strong>。</li>
</ol></li>
</ol>

</section>
<div class="entry-links"></div>
</article>
<div class="share-icons-body">
  <a href="http://www.twitter.com/share?url=http%3a%2f%2ftfjiang.github.io%2fpost%2fface_beautify%2f" target="_blank">
  <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
  <g>
    <g>
      <path d="M437.219,245.162c0-3.088-0.056-6.148-0.195-9.18c13.214-9.848,24.675-22.171,33.744-36.275
        c-12.129,5.453-25.148,9.097-38.835,10.626c13.965-8.596,24.675-22.338,29.738-38.834c-13.075,7.928-27.54,13.603-42.924,16.552
        c-12.323-14.021-29.904-22.95-49.35-23.284c-37.332-0.612-67.598,30.934-67.598,70.463c0,5.619,0.584,11.072,1.752,16.329
        c-56.22-3.616-106.042-32.881-139.369-77c-5.814,10.571-9.152,22.922-9.152,36.164c0,25.037,11.934,47.291,30.071,60.421
        c-11.099-0.5-21.503-3.866-30.627-9.375c0,0.306,0,0.612,0,0.918c0,34.996,23.312,64.316,54.245,71.159
        c-5.675,1.613-11.656,2.448-17.804,2.421c-4.367-0.028-8.596-0.501-12.713-1.392c8.596,28.681,33.577,49.628,63.147,50.323
        c-23.145,19.194-52.298,30.655-83.955,30.572c-5.453,0-10.849-0.361-16.135-1.029c29.933,20.53,65.456,32.491,103.65,32.491
        C369.23,447.261,437.219,339.048,437.219,245.162z"/>
      <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
        C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
        S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
    </g>
  </svg></a>
  <a href="http://plus.google.com/share?url=http%3a%2f%2ftfjiang.github.io%2fpost%2fface_beautify%2f" target="_blank">
  <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
    <g>
      <g>
        <path d="M349.146,402.251c0-30.016-17.387-44.815-36.525-60.922l-15.662-12.185c-4.785-3.895-11.294-9.124-11.294-18.693
          c0-9.57,6.537-15.662,12.184-21.309c18.249-14.354,36.526-29.571,36.526-61.756c0-33.076-20.892-50.462-30.878-58.724l0,0h26.956
          L358.271,153h-89.603c-23.479,0-53.049,3.478-77.863,23.924c-18.693,16.079-27.818,38.278-27.818,58.279
          c0,33.911,26.093,68.294,72.188,68.294c4.368,0,9.125-0.445,13.937-0.863c-2.17,5.23-4.34,9.569-4.34,16.97
          c0,13.464,6.955,21.753,13.047,29.57c-19.556,1.308-56.109,3.478-83.065,20.001c-25.676,15.217-33.493,37.416-33.493,53.077
          c0,32.186,30.461,62.201,93.525,62.201C309.561,484.454,349.146,443.116,349.146,402.251z M255.621,291.34
          c-37.415,0-54.384-48.292-54.384-77.418c0-11.322,2.17-23.034,9.569-32.186c6.955-8.707,19.139-14.382,30.461-14.382
          c36.108,0,54.802,48.738,54.802,80.033c0,7.845-0.862,21.754-10.877,31.768C278.237,286.11,266.498,291.312,255.621,291.34z
           M256.066,466.177c-46.54,0-76.556-22.171-76.556-53.049s27.846-41.311,37.416-44.787c18.276-6.093,41.755-6.982,45.677-6.982
          c4.34,0,6.51,0,9.987,0.445c33.076,23.479,47.402,35.218,47.402,57.416C319.992,446.176,297.821,466.177,256.066,466.177z"/>
        <polygon points="353.068,317.768 400.164,317.768 400.164,364.836 423.699,364.836 423.699,317.768 470.768,317.768 
          470.768,294.233 423.699,294.233 423.699,247.165 400.164,247.165 400.164,294.233 353.068,294.233     "/>
        <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
          C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
          S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
      </g>
  </svg></a>
  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftfjiang.github.io%2fpost%2fface_beautify%2f" target="_blank">
  <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
     viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
  <g>
    <g>
      <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
        C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
        S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
      <path d="M317.739,482.617V306h58.279l9.208-58.529h-67.487v-29.348c0-15.272,5.007-29.849,26.928-29.849h43.813v-58.418h-62.201
        c-52.298,0-66.569,34.438-66.569,82.175v35.413h-35.885V306h35.885v176.617H317.739L317.739,482.617z"/>
    </g>
  </svg>
  </a>
</div>
<div class="clearfix"></div>
<figure class="author-bio">


</figure>
<hr>

</section>
<div class="clear"></div>
</div>
<footer id="footer" style="color: #7A7B7C; background-color: #3A3B3C;background-image: url(http://tfjiang.github.io//img/texture.png),linear-gradient(to bottom, #3A3B3C, #1d1e1e); background-repeat: repeat, no-repeat; background-position: left top, left top; background-size: 100px 100px, 100% 100%;">
  <div id="footer-container">
  
  
  
  <div class="clearfix"></div>
  </div>
  <div id="copyright"></div>
</footer>
<script src="http://tfjiang.github.io//js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
</div>
</body>
    <link rel="shortcut icon" href="http://tfjiang.github.io//img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://tfjiang.github.io//img/apple-touch-icon.jpg" />
    <script type="text/javascript"
     src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
   </script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>
</html>
